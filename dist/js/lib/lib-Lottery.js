define(function(){function t(t,i,n,s,o,a){this.conId=t,this.conNode=document.getElementById(this.conId),this.cover=i,this.coverType=n,this.background=null,this.backCtx=null,this.mask=null,this.maskCtx=null,this.lottery=null,this.lotteryType="image",this.width=s||300,this.height=o||100,this.clientRect=null,this.drawPercentCallback=a,this.conNode.style.width=this.width+"px",this.conNode.style.height=this.height+"px";var h=this;"static"==e(this.conNode,"position")&&window.requestAnimationFrame(function(){h.conNode.style.position="relative"})}function e(t,e){return window.getComputedStyle?window.getComputedStyle(t,null)[e]:t.currentStyle[e]}return t.prototype={createElement:function(t,e){var i=document.createElement(t);for(var n in e)i.setAttribute(n,e[n]);return i},getTransparentPercent:function(t,e,i){for(var n=t.getImageData(0,0,e,i).data,s=[],o=0,a=n.length;o<a;o+=4)n[o+3]<128&&s.push(o);return(s.length/(n.length/4)*100).toFixed(2)},resizeCanvas:function(t,e,i){t.width=e,t.height=i,t.getContext("2d").clearRect(0,0,e,i)},drawPoint:function(t,e){this.maskCtx.beginPath();var i=this.maskCtx.createRadialGradient(t,e,0,t,e,30);i.addColorStop(0,"rgba(0,0,0,0.6)"),i.addColorStop(1,"rgba(255, 255, 255, 0)"),this.maskCtx.fillStyle=i,this.maskCtx.arc(t,e,30,0,2*Math.PI,!0),this.maskCtx.fill(),this.drawPercentCallback&&this.drawPercentCallback.call(null,this.getTransparentPercent(this.maskCtx,this.width,this.height))},bindEvent:function(){var t=this,e=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent.toLowerCase()),i=e?"touchstart":"mousedown",n=e?"touchmove":"mousemove",s=document.getElementById(this.conId);if(e)s.addEventListener("touchmove",function(t){o&&t.preventDefault()},!1),s.addEventListener("touchend",function(t){o=!1},!1);else{var o=!1;s.addEventListener("mouseup",function(t){o=!1},!1)}this.mask.addEventListener(i,function(i){o=!0;var n=document.documentElement;t.clientRect||(t.clientRect={left:0,top:0});var s=(e?i.touches[0].clientX:i.clientX)-t.clientRect.left+n.scrollLeft-n.clientLeft,a=(e?i.touches[0].clientY:i.clientY)-t.clientRect.top+n.scrollTop-n.clientTop;t.drawPoint(s,a)},!1),this.mask.addEventListener(n,function(i){if(!e&&!o)return!1;var n=document.documentElement;t.clientRect||(t.clientRect={left:0,top:0});var s=(e?i.touches[0].clientX:i.clientX)-t.clientRect.left+n.scrollLeft-n.clientLeft,a=(e?i.touches[0].clientY:i.clientY)-t.clientRect.top+n.scrollTop-n.clientTop;t.drawPoint(s,a)},!1)},drawLottery:function(){if(this.background=this.background||this.createElement("canvas",{style:"position:absolute;left:0;top:0;"}),this.mask=this.mask||this.createElement("canvas",{style:"position:absolute;left:0;top:0;"}),this.conNode.innerHTML.replace(/[\w\W]| /g,"")||(this.conNode.appendChild(this.background),this.conNode.appendChild(this.mask),this.clientRect=this.conNode?this.conNode.getBoundingClientRect():null,this.bindEvent()),this.backCtx=this.backCtx||this.background.getContext("2d"),this.maskCtx=this.maskCtx||this.mask.getContext("2d"),"image"==this.lotteryType){var t=new Image,e=this;t.onload=function(){e.resizeCanvas(e.background,e.width,e.height),e.backCtx.drawImage(this,0,0),e.drawMask()},t.src=this.lottery}else if("text"==this.lotteryType){this.resizeCanvas(this.background,this.width,this.height),this.backCtx.save(),this.backCtx.fillStyle="#FFF",this.backCtx.fillRect(0,0,this.width,this.height),this.backCtx.restore(),this.backCtx.save();this.backCtx.font="Bold 30px Arial",this.backCtx.textAlign="center",this.backCtx.fillStyle="#F60",this.backCtx.fillText(this.lottery,this.width/2,this.height/2+15),this.backCtx.restore(),this.drawMask()}},drawMask:function(){if(this.resizeCanvas(this.mask,this.width,this.height),"color"==this.coverType)this.maskCtx.fillStyle=this.cover,this.maskCtx.fillRect(0,0,this.width,this.height),this.maskCtx.globalCompositeOperation="destination-out";else if("image"==this.coverType){var t=new Image,e=this;t.onload=function(){e.maskCtx.drawImage(this,0,0),e.maskCtx.globalCompositeOperation="destination-out"},t.src=this.cover}},init:function(t,e){this.lottery=t,this.lotteryType=e||"image",this.drawLottery()}},t});